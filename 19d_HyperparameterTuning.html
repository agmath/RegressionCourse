<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-08-03">

<title>Hyperparameters and Model Tuning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="19d_HyperparameterTuning_files/libs/clipboard/clipboard.min.js"></script>
<script src="19d_HyperparameterTuning_files/libs/quarto-html/quarto.js"></script>
<script src="19d_HyperparameterTuning_files/libs/quarto-html/popper.min.js"></script>
<script src="19d_HyperparameterTuning_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="19d_HyperparameterTuning_files/libs/quarto-html/anchor.min.js"></script>
<link href="19d_HyperparameterTuning_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="19d_HyperparameterTuning_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="19d_HyperparameterTuning_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="19d_HyperparameterTuning_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="19d_HyperparameterTuning_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="19d_HyperparameterTuning_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="19d_HyperparameterTuning_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#recap" id="toc-recap" class="nav-link active" data-scroll-target="#recap">Recap</a></li>
  <li><a href="#objectives" id="toc-objectives" class="nav-link" data-scroll-target="#objectives">Objectives</a></li>
  <li><a href="#tuning-hyperparameters-for-a-single-model" id="toc-tuning-hyperparameters-for-a-single-model" class="nav-link" data-scroll-target="#tuning-hyperparameters-for-a-single-model">Tuning Hyperparameters for a Single Model</a></li>
  <li><a href="#tuning-hyperparameters-across-a-workflow-set" id="toc-tuning-hyperparameters-across-a-workflow-set" class="nav-link" data-scroll-target="#tuning-hyperparameters-across-a-workflow-set">Tuning Hyperparameters Across a Workflow Set</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="19d_HyperparameterTuning.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Hyperparameters and Model Tuning</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 3, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("xgboost")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modeldata)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tidymodels_prefer</span>()</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">kable_styling_bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"hover"</span>, <span class="st">"striped"</span>))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Set ggplot base theme</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">14</span>))</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>ames <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/koalaverse/homlr/master/data/ames.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="recap" class="level2">
<h2 class="anchored" data-anchor-id="recap">Recap</h2>
<p>In our most recent notebooks, we’ve gone beyond <em>Ordinary Least Squares</em> and explored additional classes of model. We began with <em>penalized</em> least squares models like Ridge Regression and the LASSO. We extended our knowledge of model classes to <em>nearest neighbor</em> and <em>tree-based models</em> as well as <em>ensembles</em> of models in the previous notebook. We ended that notebook with a short discussion on parameter choices that must be made prior to model training – such parameters are known as <em>hyperparameters</em>. In this notebook, we learn how to use <em>cross-validation</em> to <em>tune</em> our model <em>hyperparameters</em>.</p>
</section>
<section id="objectives" class="level2">
<h2 class="anchored" data-anchor-id="objectives">Objectives</h2>
<p>In this notebook, we’ll accomplish the following:</p>
<ul>
<li>Use <code>tune()</code> for model parameters as well as in feature engineering steps to identify hyperparameters that we want to tune through cross-validation.</li>
<li>Use cross-validation and <code>tune_grid()</code> to tune the hyperparameters for a single model, identify the best hyperparameter choices, and fit the model using those best choices.</li>
<li>Build a <code>workflow_set()</code>, choose hyperparameters that must be tuned for each model and recipe, use <em>cross-validation</em> to tune models and select “optimal” hyperparameter values, and compare the models in the workflow set.</li>
</ul>
</section>
<section id="tuning-hyperparameters-for-a-single-model" class="level2">
<h2 class="anchored" data-anchor-id="tuning-hyperparameters-for-a-single-model">Tuning Hyperparameters for a Single Model</h2>
<p>Let’s start with a decision tree model and we’ll tune the tree depth parameter. We’ll work with the <code>ames</code> data again for now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ames_known_prices <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Sale_Price))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames_known_prices, <span class="at">prop =</span> <span class="fl">0.9</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>ames_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>tree_spec <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(<span class="at">tree_depth =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>tree_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_unknown</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>tree_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tree_spec) <span class="sc">%&gt;%</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(tree_rec)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>tree_results <span class="ot">&lt;-</span> tree_wf <span class="sc">%&gt;%</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(ames_folds, <span class="at">grid =</span><span class="dv">12</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>tree_results <span class="sc">%&gt;%</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="19d_HyperparameterTuning_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see from the plots above that deeper trees seemed to perform better than shallow trees. We don’t observe much improvement in performance after a depth of 5. The risk of overfitting increases with deeper trees. We do seem to get some benefit by increasing the depth of the tree beyond 4. For this reason, I’ll choose a tree depth of 5. The output of <code>show_best()</code> below shows our best-performing depths in terms of RMSE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>tree_results <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_best</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in show_best(., n = 10): No value of `metric` was given; "rmse" will be
used.</code></pre>
</div>
<div class="cell-output-display">
<table class="table table-hover table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">tree_depth</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">.metric</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">.estimator</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std_err</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">.config</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">12</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">41775.44</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">704.2423</td>
<td style="text-align: left;">Preprocessor1_Model01</td>
</tr>
<tr class="even">
<td style="text-align: right;">7</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">41775.44</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">704.2423</td>
<td style="text-align: left;">Preprocessor1_Model02</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">41775.44</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">704.2423</td>
<td style="text-align: left;">Preprocessor1_Model03</td>
</tr>
<tr class="even">
<td style="text-align: right;">11</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">41775.44</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">704.2423</td>
<td style="text-align: left;">Preprocessor1_Model05</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">41775.44</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">704.2423</td>
<td style="text-align: left;">Preprocessor1_Model06</td>
</tr>
<tr class="even">
<td style="text-align: right;">15</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">41775.44</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">704.2423</td>
<td style="text-align: left;">Preprocessor1_Model07</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">41775.44</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">704.2423</td>
<td style="text-align: left;">Preprocessor1_Model08</td>
</tr>
<tr class="even">
<td style="text-align: right;">13</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">41775.44</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">704.2423</td>
<td style="text-align: left;">Preprocessor1_Model10</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">45387.60</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">1158.2563</td>
<td style="text-align: left;">Preprocessor1_Model04</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">50978.88</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">1129.1382</td>
<td style="text-align: left;">Preprocessor1_Model09</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can now build a final fit using this depth.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>best_params <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">tree_depth =</span> <span class="dv">5</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>tree_wf_final <span class="ot">&lt;-</span> tree_wf <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_params)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>tree_fit <span class="ot">&lt;-</span> tree_wf_final <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>tree_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: decision_tree()

── Preprocessor ────────────────────────────────────────────────────────────────
3 Recipe Steps

• step_other()
• step_unknown()
• step_impute_median()

── Model ───────────────────────────────────────────────────────────────────────
n= 2637 

node), split, n, deviance, yval
      * denotes terminal node

 1) root 2637 1.667211e+13 180558.00  
   2) Garage_Cars&lt; 2.5 2285 6.690571e+12 161328.70  
     4) Overall_Qual=Above_Average,Average,Below_Average,other 1640 2.917557e+12 141681.30  
       8) Gr_Liv_Area&lt; 1376.5 1005 8.828377e+11 125065.70  
        16) Overall_Qual=Below_Average,other 192 1.774146e+11  93651.44 *
        17) Overall_Qual=Above_Average,Average 813 4.711992e+11 132484.60 *
       9) Gr_Liv_Area&gt;=1376.5 635 1.318134e+12 167978.40  
        18) Kitchen_Qual=Typical,other 436 4.940404e+11 154393.50 *
        19) Kitchen_Qual=Excellent,Good 199 5.673376e+11 197742.40  
          38) Overall_Qual=Above_Average,Average,Below_Average 179 3.099228e+11 186715.90 *
          39) Overall_Qual=other 20 4.086997e+10 296429.20 *
     5) Overall_Qual=Good,Very_Good 645 1.530270e+12 211284.80  
      10) First_Flr_SF&lt; 1493 510 8.232808e+11 199269.20  
        20) Gr_Liv_Area&lt; 1779.5 355 3.616527e+11 185992.10 *
        21) Gr_Liv_Area&gt;=1779.5 155 2.557208e+11 229678.00 *
      11) First_Flr_SF&gt;=1493 135 3.551916e+11 256677.40 *
   3) Garage_Cars&gt;=2.5 352 3.651879e+12 305384.50  
     6) Kitchen_Qual=Good,Typical 233 1.258540e+12 262063.60  
      12) Year_Remod_Add&lt; 1979 32 4.427554e+10 148371.90 *
      13) Year_Remod_Add&gt;=1979 201 7.347876e+11 280163.80  
        26) Gr_Liv_Area&lt; 1963 116 2.461216e+11 252483.00 *
        27) Gr_Liv_Area&gt;=1963 85 2.784864e+11 317939.80 *
     7) Kitchen_Qual=Excellent 119 1.099895e+12 390206.30  
      14) Gr_Liv_Area&lt; 2220 63 1.663214e+11 344960.40 *
      15) Gr_Liv_Area&gt;=2220 56 6.595061e+11 441107.80 *</code></pre>
</div>
</div>
<p>We can see the tree as well, using <code>rpart.plot()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>tree_fit_for_plot <span class="ot">&lt;-</span> tree_fit <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(tree_fit_for_plot, <span class="at">tweak =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Cannot retrieve the data used to build the model (so cannot determine roundint and is.binary for the variables).
To silence this warning:
    Call rpart.plot with roundint=FALSE,
    or rebuild the rpart model with model=TRUE.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="19d_HyperparameterTuning_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The model we built above can be interpreted and can also be utilized to make predictions on new data just like out previous models. Next, let’s look at how we can tune multiple models with a variety of hyperparameters in a <code>workflow_set()</code>. We’ll fit a <em>LASSO</em>, a <em>random forest</em>, and a <em>gradient boosted</em> model.</p>
</section>
<section id="tuning-hyperparameters-across-a-workflow-set" class="level2">
<h2 class="anchored" data-anchor-id="tuning-hyperparameters-across-a-workflow-set">Tuning Hyperparameters Across a Workflow Set</h2>
<p>Let’s create model specifications and recipes for each of the models mentioned in earlier notebooks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>doParallel<span class="sc">::</span><span class="fu">registerDoParallel</span>()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>lasso_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), <span class="at">mixture =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="fu">tune</span>(), <span class="at">trees =</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>gb_spec <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">mtry =</span> <span class="fu">tune</span>(), <span class="at">trees =</span> <span class="dv">100</span>, <span class="at">learn_rate =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>rec_list <span class="ot">=</span> <span class="fu">list</span>(<span class="at">rec =</span> rec)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>model_list <span class="ot">=</span> <span class="fu">list</span>(<span class="at">lasso =</span> lasso_spec, <span class="at">rf =</span> rf_spec, <span class="at">gb_tree =</span> gb_spec)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>model_wfs <span class="ot">&lt;-</span> <span class="fu">workflow_set</span>(rec_list, model_list, <span class="at">cross =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>grid_ctrl <span class="ot">&lt;-</span> <span class="fu">control_grid</span>(</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_pred =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_over =</span> <span class="st">"everything"</span>,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_workflow =</span> <span class="cn">TRUE</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>grid_results <span class="ot">&lt;-</span> model_wfs <span class="sc">%&gt;%</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> ames_folds,</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> <span class="dv">5</span>,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> grid_ctrl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>i Creating pre-processing data to finalize unknown parameter: mtry
i Creating pre-processing data to finalize unknown parameter: mtry</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>grid_results <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="19d_HyperparameterTuning_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s see what the best models were!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>grid_results <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rank_results</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-hover table-striped caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">wflow_id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">.config</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">.metric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">std_err</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">n</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">preprocessor</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">model</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">rec_gb_tree</td>
<td style="text-align: left;">Preprocessor1_Model2</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">2.405655e+04</td>
<td style="text-align: right;">782.1749664</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_gb_tree</td>
<td style="text-align: left;">Preprocessor1_Model2</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">9.092399e-01</td>
<td style="text-align: right;">0.0054418</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_gb_tree</td>
<td style="text-align: left;">Preprocessor1_Model3</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">2.460431e+04</td>
<td style="text-align: right;">1185.2240259</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_gb_tree</td>
<td style="text-align: left;">Preprocessor1_Model3</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">9.057068e-01</td>
<td style="text-align: right;">0.0092678</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_rf</td>
<td style="text-align: left;">Preprocessor1_Model3</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">2.649436e+04</td>
<td style="text-align: right;">751.2181872</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_rf</td>
<td style="text-align: left;">Preprocessor1_Model3</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.922140e-01</td>
<td style="text-align: right;">0.0039914</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_rf</td>
<td style="text-align: left;">Preprocessor1_Model5</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">2.667734e+04</td>
<td style="text-align: right;">880.1102319</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_rf</td>
<td style="text-align: left;">Preprocessor1_Model5</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.914213e-01</td>
<td style="text-align: right;">0.0067577</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_rf</td>
<td style="text-align: left;">Preprocessor1_Model1</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">2.681196e+04</td>
<td style="text-align: right;">776.3474654</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_rf</td>
<td style="text-align: left;">Preprocessor1_Model1</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.896710e-01</td>
<td style="text-align: right;">0.0055748</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_rf</td>
<td style="text-align: left;">Preprocessor1_Model2</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">2.702251e+04</td>
<td style="text-align: right;">727.9304682</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_rf</td>
<td style="text-align: left;">Preprocessor1_Model2</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.876737e-01</td>
<td style="text-align: right;">0.0053559</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_lasso</td>
<td style="text-align: left;">Preprocessor1_Model5</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">3.463037e+04</td>
<td style="text-align: right;">2726.0237672</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_lasso</td>
<td style="text-align: left;">Preprocessor1_Model5</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.178759e-01</td>
<td style="text-align: right;">0.0241675</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_lasso</td>
<td style="text-align: left;">Preprocessor1_Model1</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">3.463037e+04</td>
<td style="text-align: right;">2726.0237672</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_lasso</td>
<td style="text-align: left;">Preprocessor1_Model1</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.178759e-01</td>
<td style="text-align: right;">0.0241675</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_lasso</td>
<td style="text-align: left;">Preprocessor1_Model2</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">3.463037e+04</td>
<td style="text-align: right;">2726.0237672</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_lasso</td>
<td style="text-align: left;">Preprocessor1_Model2</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.178759e-01</td>
<td style="text-align: right;">0.0241675</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_lasso</td>
<td style="text-align: left;">Preprocessor1_Model3</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">3.463037e+04</td>
<td style="text-align: right;">2726.0237672</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_lasso</td>
<td style="text-align: left;">Preprocessor1_Model3</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.178759e-01</td>
<td style="text-align: right;">0.0241675</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_lasso</td>
<td style="text-align: left;">Preprocessor1_Model4</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">3.463037e+04</td>
<td style="text-align: right;">2726.0237672</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: right;">11</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_lasso</td>
<td style="text-align: left;">Preprocessor1_Model4</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.178759e-01</td>
<td style="text-align: right;">0.0241675</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">linear_reg</td>
<td style="text-align: right;">11</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_gb_tree</td>
<td style="text-align: left;">Preprocessor1_Model1</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">3.984044e+04</td>
<td style="text-align: right;">1111.5806383</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_gb_tree</td>
<td style="text-align: left;">Preprocessor1_Model1</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.865721e-01</td>
<td style="text-align: right;">0.0067209</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_rf</td>
<td style="text-align: left;">Preprocessor1_Model4</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">4.678976e+04</td>
<td style="text-align: right;">1368.0043202</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_rf</td>
<td style="text-align: left;">Preprocessor1_Model4</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.019057e-01</td>
<td style="text-align: right;">0.0073440</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">rand_forest</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_gb_tree</td>
<td style="text-align: left;">Preprocessor1_Model5</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">9.912738e+04</td>
<td style="text-align: right;">945.9103046</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: right;">14</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_gb_tree</td>
<td style="text-align: left;">Preprocessor1_Model5</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.504925e-01</td>
<td style="text-align: right;">0.0081082</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: right;">14</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rec_gb_tree</td>
<td style="text-align: left;">Preprocessor1_Model4</td>
<td style="text-align: left;">rmse</td>
<td style="text-align: right;">1.654890e+05</td>
<td style="text-align: right;">1168.5860783</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: right;">15</td>
</tr>
<tr class="even">
<td style="text-align: left;">rec_gb_tree</td>
<td style="text-align: left;">Preprocessor1_Model4</td>
<td style="text-align: left;">rsq</td>
<td style="text-align: right;">8.555862e-01</td>
<td style="text-align: right;">0.0076431</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">recipe</td>
<td style="text-align: left;">boost_tree</td>
<td style="text-align: right;">15</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The model performing the best was the <em>gradient boosted tree ensemble</em>. Let’s see what hyperparameter choices led to the best performance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>grid_results <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>, <span class="at">id =</span> <span class="st">"rec_gb_tree"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="19d_HyperparameterTuning_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It seems that a number of randomly selected parameters of near 30 gave the best performance and learning rates near 0.1 did as well. We’ll construct this model and fit it to our training data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>gb_tree_spec <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">mtry =</span> <span class="dv">30</span>, <span class="at">trees =</span> <span class="dv">100</span>, <span class="at">learn_rate =</span> <span class="fl">0.1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>gb_tree_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(gb_tree_spec) <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rec)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>gb_tree_fit <span class="ot">&lt;-</span> gb_tree_wf <span class="sc">%&gt;%</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Such a model doesn’t have much interpretive value but can make very good predictions. We can identify the predictors which were most important within the ensemble by using <code>var_imp()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>gb_tree_fit <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_engine</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="19d_HyperparameterTuning_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From the plot above, we can see the features that were most the important predictors of <em>selling price</em> within the ensemble. Note that the important predictors will shuffle around slightly each time you re-run the ensemble. Before we close this notebook, let’s take a look at how well this model predicts the selling prices of homes in our <em>test</em> set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>gb_results <span class="ot">&lt;-</span> gb_tree_fit <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>(ames_test) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sale_Price, .pred) <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(Sale_Price, .pred) </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>gb_results <span class="sc">%&gt;%</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">.metric</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">.estimator</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">.estimate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">20582.85</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>This final ensemble of models predicted selling prices of homes with an root mean squared error of $ 20,582.85.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this notebook, we saw how to build a workflow set consisting of several models with tunable hyperparameters. We explored a <em>space-filling grid</em> of hyperparameter combinations with a <code>workflow_map()</code>. After identifying a best model and optimal(*) hyperparameter choices, we fit the corresponding model to our training data and then assessed that model’s performance on our test data.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>